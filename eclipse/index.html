<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>

<body>
    <div class="timebox">
        <p class="text" id="timer">Loading...</p>
    </div>
    <div class="progressbox">
        <p class="text" id="countdown">Loading...</p>
    </div>

    <style>
        @font-face {
            font-family: "vcr-osd-mono";
            src: url('./vcr.ttf');
        }
        
        .timebox {
            position: absolute;
            top: -35;
            right: 20;
        }
        
        .progressbox {
            position: absolute;
            top: 70;
            right: 20;
        }
        
        .text {
            padding: 20px;
            background: rgb(0, 163, 224);
            font-family: "vcr-osd-mono";
            font-size: 40pt;
            color: #fff;
            overflow: hidden;
        }
    </style>
</body>

<script src="./cash.min.js"></script>
<script src="./moment-with-locales.min.js"></script>
<script src="./moment-timezone-with-data-10-year-range.min.js"></script>

<script async>
    moment.locale("cs");
    var target = getQueryVariable("timezone");

    var tz = Object.keys(moment.tz._names).find((e) => {
        let name = moment.tz._names[e];
        return moment.tz.zone(name).abbr(moment()) === target;
    });

    // Update the count down every 1 second
    var x = setInterval(update, 1000);

    function update() {
        // Display the result in the element with id="demo"
        if (tz == null) {
            throwError("Unable to find timezone " + target);
        }
        document.getElementById("timer").innerHTML = moment().tz(moment.tz.guess()).format('HH:mm:ss z') + " // " + moment().tz(tz).format('HH:mm:ss z');
        updateProgress()
    }

    function getQueryVariable(variable) {
        var query = window.location.search.substring(1);
        var vars = query.split("&");
        for (var i = 0; i < vars.length; i++) {
            var pair = vars[i].split("=");
            if (pair[0] == variable) {
                return pair[1];
            }
        }
        throwError("Value \'" + variable + "\' not found!");
    }

    function updateProgress() {
        let start = moment(getQueryVariable("eclStart"));
        let end = moment(getQueryVariable("eclEnd"));
        if (moment().isBefore(start)) {
            let untilstart = moment.duration(start.tz(tz).diff(moment()));
            document.getElementById("countdown").innerHTML = untilstart.humanize(true);
        } else {
            let untilend = moment.duration(end.tz(tz).diff(moment()));
            document.getElementById("countdown").innerHTML = untilend.humanize(true);
        }
    }

    function throwError(msg) {
        $(".text").css("background", "rgb(135,0,0)");
        document.getElementById("timer").innerHTML = msg;
        clearInterval(x);
    }

    update();
</script>e();
</script>